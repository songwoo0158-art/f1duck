<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My F1 Hub (v6 - Verification Fix)</title>
    <style>
        /* CSSëŠ” V5ì™€ ë™ì¼ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
        }
        h2 {
            color: #18181b;
        }
        #filter-container {
            margin-bottom: 20px;
        }
        .filter-btn {
            padding: 8px 15px;
            margin-right: 10px;
            border: none;
            border-radius: 6px;
            background-color: #ffffff;
            color: #333;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: background-color 0.2s;
        }
        .filter-btn:hover {
            background-color: #e9e9ed;
        }
        .filter-btn.active {
            background-color: #0d6efd;
            color: white;
        }
        #shorts-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        .video-item {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.2s ease;
            cursor: pointer;
        }
        .video-item:hover {
            transform: translateY(-5px);
        }
        .video-item img {
            width: 100%;
            height: auto;
            display: block;
        }
        .video-item p {
            padding: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .video-item iframe {
            width: 100%;
            height: 400px;
            border: none;
            display: block;
        }
        #pagination-container {
            text-align: center;
            margin-top: 25px;
        }
        #next-page-btn {
            padding: 10px 20px;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            background-color: #0d6efd;
            color: white;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            display: none;
        }
        #next-page-btn:hover {
            background-color: #0b5ed7;
        }
    </style>

    <script>
        // 1. ì—¬ê¸°ì— ë°œê¸‰ë°›ì€ API í‚¤ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”. (íŒŒì¼ ìƒë‹¨)
        const API_KEY = 'AIzaSyDs3rdUWpFuNlsST16Do4Fb3pCn3gBf0PA';

        document.addEventListener('DOMContentLoaded', function() {
            const shortsContainer = document.getElementById('shorts-container');
            const filterButtons = document.querySelectorAll('.filter-btn');
            const nextPageButton = document.getElementById('next-page-btn');
            
            let currentNextPageToken = null; 
            let currentBaseUrl = ''; 

            function getPublishedAfterDate(period) {
                const date = new Date();
                switch (period) {
                    case 'today':
                        date.setDate(date.getDate() - 1);
                        break;
                    case 'week':
                        date.setDate(date.getDate() - 7);
                        break;
                    case 'month':
                        date.setDate(date.getDate() - 30);
                        break;
                    case 'all':
                    default:
                        return null;
                }
                return date.toISOString(); 
            }

            function createBaseApiUrl(period) {
                const publishedAfter = getPublishedAfterDate(period);
                // V4ì˜ videoEmbeddable=true í•„í„°ëŠ” 1ì°¨ ë°©ì–´ìš©ìœ¼ë¡œ ë‚¨ê²¨ë‘¡ë‹ˆë‹¤.
                let url = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=F1&order=viewCount&type=video&videoDuration=short&videoEmbeddable=true&maxResults=12&key=${API_KEY}`;
                
                if (publishedAfter) {
                    url += `&publishedAfter=${publishedAfter}`;
                }
                return url;
            }

            /**
             * (v6) ë™ì˜ìƒì„ ê°€ì ¸ì™€ì„œ í‘œì‹œí•˜ëŠ” ë©”ì¸ í•¨ìˆ˜ - 2ë‹¨ê³„ ê²€ì¦ ì¶”ê°€
             */
            function fetchAndDisplayVideos(apiUrl, isPagination = false) {
                if (!isPagination) {
                    shortsContainer.innerHTML = '';
                    currentNextPageToken = null; 
                    nextPageButton.style.display = 'none'; 
                }
                
                let searchItems = []; // 1ë‹¨ê³„ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì €ì¥í•  ë³€ìˆ˜

                // --- 1ë‹¨ê³„: ê²€ìƒ‰ (Search) ---
                fetch(apiUrl)
                    .then(response => response.json())
                    .then(data => {
                        currentNextPageToken = data.nextPageToken || null;
                        searchItems = data.items || [];

                        if (searchItems.length === 0) {
                            if (!isPagination) {
                                shortsContainer.innerHTML = "<p>í•´ë‹¹ ê¸°ê°„ì— ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>";
                            }
                            return null; // ê²€ì¦ ë‹¨ê³„ë¡œ ë„˜ì–´ê°€ì§€ ì•ŠìŒ
                        }

                        // 1ë‹¨ê³„ ê²°ê³¼ê°€ ìˆìœ¼ë©´, 2ë‹¨ê³„(ê²€ì¦)ë¥¼ ìœ„í•´ ID ëª©ë¡ì„ ë§Œë“­ë‹ˆë‹¤.
                        const videoIds = searchItems.map(item => item.id.videoId).join(',');
                        const verificationUrl = `https://www.googleapis.com/youtube/v3/videos?part=status&id=${videoIds}&key=${API_KEY}`;
                        
                        // --- 2ë‹¨ê³„: ê²€ì¦ (Videos: list) ---
                        return fetch(verificationUrl); // ë‹¤ìŒ thenìœ¼ë¡œ fetch ê²°ê³¼ë¥¼ ë„˜ê¹€
                    })
                    .then(response => {
                        if (response === null) return null; // 1ë‹¨ê³„ì—ì„œ ê²°ê³¼ê°€ ì—†ì—ˆìœ¼ë©´ ì¤‘ë‹¨
                        return response.json();
                    })
                    .then(videoData => {
                        if (videoData === null) return; // 1ë‹¨ê³„ì—ì„œ ê²°ê³¼ê°€ ì—†ì—ˆìœ¼ë©´ ì¤‘ë‹¨

                        // 2ë‹¨ê³„: ì‹¤ì œ 'embeddable'í•œ ID ëª©ë¡ì„ Setìœ¼ë¡œ ë§Œë“­ë‹ˆë‹¤.
                        const embeddableIds = new Set(
                            videoData.items
                                .filter(item => item.status.embeddable)
                                .map(item => item.id)
                        );

                        // --- 3ë‹¨ê³„: 1ë‹¨ê³„ ê²°ê³¼(searchItems)ë¥¼ 2ë‹¨ê³„(embeddableIds)ë¡œ í•„í„°ë§ ---
                        const displayItems = searchItems.filter(item => 
                            embeddableIds.has(item.id.videoId)
                        );

                        // 'ë‹¤ìŒ' ë²„íŠ¼ í‘œì‹œ ë¡œì§ (í•„í„°ë§ í›„ì—ë„ ë‹¤ìŒ í˜ì´ì§€ í† í°ì€ ìœ íš¨í•¨)
                        if (currentNextPageToken) {
                            nextPageButton.style.display = 'block';
                        } else {
                            nextPageButton.style.display = 'none';
                        }

                        // ìµœì¢… í•„í„°ë§ëœ ê²°ê³¼ê°€ ì—†ëŠ” ê²½ìš°
                        if (displayItems.length === 0) {
                            if (!isPagination) {
                                shortsContainer.innerHTML = "<p>í•´ë‹¹ ê¸°ê°„ì— (ì¬ìƒ ê°€ëŠ¥í•œ) ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>";
                            }
                            // 'ë‹¤ìŒ' ë²„íŠ¼ì´ í‘œì‹œë˜ì—ˆë”ë¼ë„, ë” ì´ìƒ ë¡œë“œí•  ê²Œ ì—†ìœ¼ë©´ ìˆ¨ê¸¸ ìˆ˜ ìˆìŒ
                            // (ë‹¨, ë‹¤ìŒ í˜ì´ì§€ì—” ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ ì¼ë‹¨ ë‘ )
                            return;
                        }

                        // 4. HTML ìƒì„± (ìµœì¢… í•„í„°ë§ëœ ì˜ìƒë§Œ)
                        displayItems.forEach(item => {
                            const videoId = item.id.videoId;
                            const title = item.snippet.title;
                            const thumbnail = item.snippet.thumbnails.medium.url;

                            const videoElement = `
                                <div class="video-item" data-videoid="${videoId}">
                                    <img src="${thumbnail}" alt="${title}">
                                    <p>${title}</p>
                                </div>
                            `;
                            shortsContainer.innerHTML += videoElement;
                        });
                    })
                    .catch(error => {
                        console.error('ìœ íŠœë¸Œ API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                        shortsContainer.innerHTML = "<p>ì½˜í…ì¸ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>";
                    });
            }

            // --- V5ì™€ ë™ì¼í•œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤ ---

            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');

                    const period = this.dataset.period;
                    currentBaseUrl = createBaseApiUrl(period);
                    
                    fetchAndDisplayVideos(currentBaseUrl, false);
                });
            });

            nextPageButton.addEventListener('click', function() {
                if (currentNextPageToken && currentBaseUrl) {
                    const nextPageUrl = `${currentBaseUrl}&pageToken=${currentNextPageToken}`;
                    fetchAndDisplayVideos(nextPageUrl, true);
                }
            });

            shortsContainer.addEventListener('click', function(event) {
                const videoItem = event.target.closest('.video-item');

                if (videoItem) {
                    if (videoItem.querySelector('iframe')) {
                        return;
                    }

                    const videoId = videoItem.dataset.videoid;
                    videoItem.innerHTML = `
                        <iframe 
                            src="https://www.youtube.com/embed/${videoId}?autoplay=1" 
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                            allowfullscreen>
                        </iframe>
                    `;
                    videoItem.style.transform = 'none';
                    videoItem.style.boxShadow = '0 4px 10px rgba(0, 0, 0, 0.2)';
                }
            });

            // í˜ì´ì§€ ì²« ë¡œë“œ ì‹œ ê¸°ë³¸ê°’ ì„¤ì •
            document.querySelector('.filter-btn[data-period="week"]').click();
        });
    </script>
</head>
<body>

    <h2>ğŸï¸ F1 ìˆí¼</h2>

    <div id="filter-container">
        <button class="filter-btn" data-period="today">ì˜¤ëŠ˜</button>
        <button class="filter-btn active" data-period="week">ì¼ì£¼ì¼</button>
        <button class="filter-btn" data-period="month">í•œë‹¬</button>
        <button class="filter-btn" data-period="all">ì˜¬íƒ€ì„</button>
    </div>
    
    <div id="shorts-container"></div>

    <div id="pagination-container">
        <button id="next-page-btn">ë‹¤ìŒ 12ê°œ ë³´ê¸°</button>
    </div>

</body>
</html>
